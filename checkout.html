<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Stickerine</title>
    <link rel="stylesheet" href="assets/auth-styles.css">
    <link rel="stylesheet" href="assets/checkout-styles.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <!-- Stripe.js for payment processing -->
    <script src="https://js.stripe.com/v3/"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="assets/header-navigation.css">
  </head>
<body>
    <header class="site-header">
        <div class="header-container">
            <a href="index.html" class="logo">
                <img src="assets/stickerverse-logo.png" alt="Stickerverse Logo">
            </a>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="collections/stickers.html">Stickers</a></li>
                    <li><a href="design.html">Design</a></li>
                    <li><a href="design-tips.html">Tips</a></li>
                    <li><a href="cart.html"><i class="fa-solid fa-shopping-cart"></i> Cart</a></li>
                    <li><a href="profile.html" id="profile-link"><i class="fa-solid fa-user"></i> <span id="user-name">Account</span></a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="checkout-container">
        <div id="checkout-loading" style="text-align: center; padding: 50px;">
            <i class="fa-solid fa-spinner fa-spin fa-3x"></i>
            <p>Loading checkout...</p>
        </div>

        <div id="checkout-auth" style="display: none; text-align: center; padding: 50px;">
            <h2>Please sign in to continue checkout</h2>
            <p>You need to sign in or create an account to complete your purchase.</p>
            <div style="margin-top: 30px;">
                <a href="login.html?redirect=checkout.html" class="btn btn-primary">Sign In</a>
                <a href="signup.html?redirect=checkout.html" class="btn btn-outline" style="margin-left: 15px;">Create Account</a>
            </div>
        </div>

        <div id="checkout-content" style="display: none;">
            <div class="checkout-steps">
                <div class="step">
                    <div class="step-icon completed">
                        <i class="fa-solid fa-shopping-cart"></i>
                    </div>
                    <div class="step-label">Cart</div>
                </div>
                <div class="step-divider"></div>
                <div class="step">
                    <div class="step-icon active">1</div>
                    <div class="step-label">Information</div>
                </div>
                <div class="step-divider"></div>
                <div class="step">
                    <div class="step-icon">2</div>
                    <div class="step-label">Payment</div>
                </div>
                <div class="step-divider"></div>
                <div class="step">
                    <div class="step-icon">3</div>
                    <div class="step-label">Confirmation</div>
                </div>
            </div>
        
        <div class="checkout-content" id="checkout-content">
            <div class="checkout-main">
                <h1>Checkout</h1>

                <!-- Customer Information - Step 1 -->
                <div id="step-1" class="checkout-section">
                    <h2>Customer Information</h2>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" disabled>
                    </div>

                    <div id="saved-addresses">
                        <h3>Saved Addresses</h3>
                        <div id="addresses-list">
                            <!-- Addresses will be populated here -->
                            <p id="no-addresses" style="display: none;">You don't have any saved addresses yet.</p>
                        </div>
                        <button id="add-new-address" class="btn btn-outline" style="margin-top: 15px;">
                            <i class="fa-solid fa-plus"></i> Add New Address
                        </button>
                    </div>

                    <div id="new-address-form" style="display: none; margin-top: 20px;">
                        <h3>New Address</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="first-name">First Name</label>
                                <input type="text" id="first-name" required>
                            </div>
                            <div class="form-group">
                                <label for="last-name">Last Name</label>
                                <input type="text" id="last-name" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="address">Address</label>
                            <input type="text" id="address" required>
                        </div>
                        <div class="form-group">
                            <label for="address2">Apartment, suite, etc. (optional)</label>
                            <input type="text" id="address2">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="city">City</label>
                                <input type="text" id="city" required>
                            </div>
                            <div class="form-group">
                                <label for="state">State/Province</label>
                                <input type="text" id="state" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="zip">Postal Code</label>
                                <input type="text" id="zip" required>
                            </div>
                            <div class="form-group">
                                <label for="country">Country</label>
                                <select id="country" required>
                                    <option value="US">United States</option>
                                    <option value="CA">Canada</option>
                                    <option value="GB">United Kingdom</option>
                                    <option value="AU">Australia</option>
                                    <!-- More countries can be added -->
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone</label>
                            <input type="tel" id="phone" required>
                        </div>
                        <div class="form-checkbox">
                            <input type="checkbox" id="save-address">
                            <label for="save-address">Save this address for future orders</label>
                        </div>

                        <div style="margin-top: 20px;">
                            <button id="cancel-new-address" class="btn btn-outline">Cancel</button>
                            <button id="save-new-address" class="btn btn-primary" style="margin-left: 10px;">Save Address</button>
                        </div>
                    </div>

                    <div class="checkout-actions">
                        <a href="cart.html" class="btn btn-outline">
                            <i class="fa-solid fa-arrow-left"></i> Return to Cart
                        </a>
                        <button id="continue-to-payment" class="btn btn-primary">
                            Continue to Payment <i class="fa-solid fa-arrow-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Payment Information - Step 2 -->
                <div id="step-2" class="checkout-section" style="display: none;">
                    <h2>Payment Method</h2>
                    
                    <div id="saved-payments">
                        <h3>Saved Payment Methods</h3>
                        <div id="payment-methods-list">
                            <!-- Payment methods will be populated here -->
                            <p id="no-payments" style="display: none;">You don't have any saved payment methods yet.</p>
                        </div>
                        <button id="add-new-payment" class="btn btn-outline" style="margin-top: 15px;">
                            <i class="fa-solid fa-plus"></i> Add New Payment Method
                        </button>
                    </div>

                    <div id="new-payment-form" style="display: none; margin-top: 20px;">
                        <h3>New Payment Method</h3>
                        <div class="form-group">
                            <label for="card-name">Name on Card</label>
                            <input type="text" id="card-name" required>
                        </div>
                        <div class="form-group">
                            <label for="card-number">Card Number</label>
                            <div class="card-input-container">
                                <div id="card-number-element" style="padding: 12px; border: 1px solid #e0e0e0; border-radius: 5px;"></div>
                                <div class="card-icons">
                                    <img src="https://cdn.shopify.com/s/files/1/0659/9398/2602/files/visa.png?v=1682956574" alt="Visa">
                                    <img src="https://cdn.shopify.com/s/files/1/0659/9398/2602/files/mastercard.png?v=1682956574" alt="Mastercard">
                                    <img src="https://cdn.shopify.com/s/files/1/0659/9398/2602/files/amex.png?v=1682956574" alt="American Express">
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="card-expiry">Expiration Date</label>
                                <div id="card-expiry-element" style="padding: 12px; border: 1px solid #e0e0e0; border-radius: 5px;"></div>
                            </div>
                            <div class="form-group">
                                <label for="card-cvc">Security Code</label>
                                <div id="card-cvc-element" style="padding: 12px; border: 1px solid #e0e0e0; border-radius: 5px;"></div>
                            </div>
                        </div>
                        <div class="form-checkbox">
                            <input type="checkbox" id="save-payment">
                            <label for="save-payment">Save this payment method for future orders</label>
                        </div>

                        <div id="card-errors" class="payment-errors" style="color: var(--danger-color); margin-top: 15px;"></div>

                        <div style="margin-top: 20px;">
                            <button id="cancel-new-payment" class="btn btn-outline">Cancel</button>
                            <button id="save-new-payment" class="btn btn-primary" style="margin-left: 10px;">Save Payment Method</button>
                        </div>
                    </div>

                    <div class="checkout-actions">
                        <button id="return-to-info" class="btn btn-outline">
                            <i class="fa-solid fa-arrow-left"></i> Return to Information
                        </button>
                        <button id="complete-order" class="btn btn-primary">
                            Complete Order <i class="fa-solid fa-check"></i>
                        </button>
                    </div>
                </div>

                <!-- Confirmation - Step 3 -->
                <div id="step-3" class="checkout-section" style="display: none; text-align: center;">
                    <i class="fa-solid fa-circle-check" style="font-size: 60px; color: var(--success-color); margin-bottom: 20px;"></i>
                    <h2>Order Confirmed!</h2>
                    <p>Thank you for your order. We've received your payment and will begin processing your order right away.</p>
                    <p>Order #: <strong id="order-number">ORD-12345</strong></p>
                    <p>A confirmation email has been sent to <strong id="confirmation-email">your@email.com</strong></p>
                    
                    <div style="margin-top: 30px;">
                        <a href="profile.html#orders" class="btn btn-outline">View Order Status</a>
                        <a href="index.html" class="btn btn-primary" style="margin-left: 15px;">Continue Shopping</a>
                    </div>
                </div>
            </div>

            <div class="checkout-sidebar">
                <!-- Order Summary -->
                <div class="order-summary">
                    <h2>Order Summary</h2>
                    <div class="order-items">
                        <!-- Order items will be populated here -->
                    </div>
                    <div class="summary-items">
                        <div class="summary-item">
                            <span>Subtotal</span>
                            <span id="subtotal">$0.00</span>
                        </div>
                        <div class="summary-item">
                            <span>Shipping</span>
                            <span id="shipping">Calculated at next step</span>
                        </div>
                        <div class="summary-item">
                            <span>Tax</span>
                            <span id="tax">Calculated at next step</span>
                        </div>
                    </div>
                    <div class="summary-total">
                        <span>Total</span>
                        <span id="total">$0.00</span>
                    </div>
                    <div class="promo-code">
                        <input type="text" id="promo" placeholder="Promo Code">
                        <button id="apply-promo" class="btn btn-outline">Apply</button>
                    </div>
                </div>

                <!-- Secure Checkout -->
                <div class="secure-checkout">
                    <div class="secure-icon">
                        <i class="fa-solid fa-lock" style="font-size: 24px; color: var(--success-color);"></i>
                    </div>
                    <div class="secure-text">
                        <h3>Secure Checkout</h3>
                        <p>Your payment information is encrypted and secure.</p>
                    </div>
                </div>

                <!-- Checkout Help -->
                <div class="checkout-help">
                    <h3>Need Help?</h3>
                    <p>Our customer service team is here to help you with your checkout.</p>
                    <a href="contact.html" class="btn-link">Contact Support</a>
                </div>
            </div>
        </div>
    </div>
    
    <footer class="site-footer">
        <div class="footer-container">
            <div class="footer-column">
                <h3>Shop</h3>
                <ul>
                    <li><a href="collections/all.html">All Products</a></li>
                    <li><a href="collections/stickers.html">Stickers</a></li>
                    <li><a href="design.html">Custom Design</a></li>
                    <li><a href="collections/deals.html">Deals</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Information</h3>
                <ul>
                    <li><a href="pages/contact.html">Contact Us</a></li>
                    <li><a href="blog.html">Blog</a></li>
                    <li><a href="design-tips.html">Design Tips</a></li>
                    <li><a href="pages/faq.html">FAQ</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Policies</h3>
                <ul>
                    <li><a href="policies/privacy-policy.html">Privacy Policy</a></li>
                    <li><a href="policies/terms-of-service.html">Terms of Service</a></li>
                    <li><a href="policies/shipping-policy.html">Shipping Policy</a></li>
                    <li><a href="policies/refund-policy.html">Refund Policy</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Follow Us</h3>
                <ul>
                    <li><a href="https://www.instagram.com/stickerine/" target="_blank"><i class="fa-brands fa-instagram"></i> Instagram</a></li>
                    <li><a href="https://www.facebook.com/stickerine/" target="_blank"><i class="fa-brands fa-facebook"></i> Facebook</a></li>
                    <li><a href="https://www.pinterest.com/stickerine/" target="_blank"><i class="fa-brands fa-pinterest"></i> Pinterest</a></li>
                    <li><a href="https://www.twitter.com/stickerine/" target="_blank"><i class="fa-brands fa-twitter"></i> Twitter</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2023 Stickerine. All rights reserved.</p>
        </div>
    </footer>
    
    <!-- Firebase Config & Scripts -->
    <script src="assets/firebase-config.js"></script>
    <script src="assets/firebase-auth.js"></script>
    <script src="assets/firebase-payment.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Firebase Auth and check authentication status
            initializeFirebaseAuth();
            
            // Check if the user is authenticated
            firebase.auth().onAuthStateChanged(function(user) {
                if (user) {
                    // User is authenticated, load checkout content
                    document.getElementById('checkout-loading').style.display = 'none';
                    document.getElementById('checkout-content').style.display = 'flex';
                    
                    // Set email field
                    document.getElementById('email').value = user.email;
                    
                    // Update user name in header
                    if (user.displayName) {
                        document.getElementById('user-name').textContent = user.displayName;
                    } else {
                        document.getElementById('user-name').textContent = 'My Account';
                    }
                    
                    // Load cart items from local storage
                    loadCartItems();
                    
                    // Load saved addresses
                    loadSavedAddresses(user.uid);
                    
                    // Load saved payment methods
                    loadSavedPaymentMethods(user.uid);

                    // Initialize Stripe elements
                    initializeStripeElements();
                } else {
                    // User is not authenticated, show auth prompt
                    document.getElementById('checkout-loading').style.display = 'none';
                    document.getElementById('checkout-auth').style.display = 'block';
                }
            });

            // Load cart items from local storage
            function loadCartItems() {
                const cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
                const orderItemsContainer = document.querySelector('.order-items');
                let subtotal = 0;

                // Clear container
                orderItemsContainer.innerHTML = '';

                if (cartItems.length === 0) {
                    orderItemsContainer.innerHTML = '<p>Your cart is empty. <a href="index.html">Continue shopping</a></p>';
                    document.getElementById('subtotal').textContent = '$0.00';
                    document.getElementById('total').textContent = '$0.00';
                    return;
                }

                // Add each item to the order summary
                cartItems.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;

                    const itemElement = document.createElement('div');
                    itemElement.className = 'order-item';
                    itemElement.innerHTML = `
                        <div class="order-item-image">
                            <img src="${item.image}" alt="${item.name}">
                        </div>
                        <div class="order-item-details">
                            <h3>${item.name}</h3>
                            <p class="item-price">$${item.price.toFixed(2)} × ${item.quantity}</p>
                            <p class="item-total">$${itemTotal.toFixed(2)}</p>
                        </div>
                    `;
                    orderItemsContainer.appendChild(itemElement);
                });

                // Update totals
                document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
                document.getElementById('total').textContent = '$' + subtotal.toFixed(2);
            }

            // Handlers for checkout step navigation
            document.getElementById('continue-to-payment').addEventListener('click', function() {
                const selectedAddress = document.querySelector('input[name="address"]:checked');
                
                if (!selectedAddress) {
                    alert('Please select or add an address to continue.');
                    return;
                }

                // Update steps UI
                document.querySelector('.step:nth-child(3) .step-icon').classList.add('active');
                document.querySelector('.step:nth-child(3) .step-icon').textContent = '2';
                document.querySelector('.step:nth-child(1) .step-icon').classList.add('completed');
                document.querySelector('.step:nth-child(1) .step-icon').innerHTML = '<i class="fa-solid fa-check"></i>';
                
                // Hide step 1, show step 2
                document.getElementById('step-1').style.display = 'none';
                document.getElementById('step-2').style.display = 'block';
            });

            document.getElementById('return-to-info').addEventListener('click', function() {
                // Update steps UI
                document.querySelector('.step:nth-child(3) .step-icon').classList.remove('active');
                document.querySelector('.step:nth-child(3) .step-icon').textContent = '2';
                document.querySelector('.step:nth-child(1) .step-icon').classList.remove('completed');
                document.querySelector('.step:nth-child(1) .step-icon').textContent = '1';
                document.querySelector('.step:nth-child(1) .step-icon').classList.add('active');
                
                // Hide step 2, show step 1
                document.getElementById('step-2').style.display = 'none';
                document.getElementById('step-1').style.display = 'block';
            });

            document.getElementById('complete-order').addEventListener('click', function() {
                const selectedPayment = document.querySelector('input[name="payment"]:checked');
                
                if (!selectedPayment) {
                    alert('Please select or add a payment method to continue.');
                    return;
                }

                // Show loading state
                this.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
                this.disabled = true;

                // Process payment
                processPayment()
                    .then(orderData => {
                        // Update steps UI
                        document.querySelector('.step:nth-child(5) .step-icon').classList.add('active');
                        document.querySelector('.step:nth-child(5) .step-icon').textContent = '3';
                        document.querySelector('.step:nth-child(3) .step-icon').classList.add('completed');
                        document.querySelector('.step:nth-child(3) .step-icon').innerHTML = '<i class="fa-solid fa-check"></i>';
                        
                        // Set order details
                        document.getElementById('order-number').textContent = orderData.orderNumber;
                        document.getElementById('confirmation-email').textContent = firebase.auth().currentUser.email;
                        
                        // Hide step 2, show step 3
                        document.getElementById('step-2').style.display = 'none';
                        document.getElementById('step-3').style.display = 'block';
                        
                        // Clear cart
                        localStorage.removeItem('cartItems');
                    })
                    .catch(error => {
                        alert('Payment processing failed: ' + error.message);
                        this.innerHTML = 'Complete Order <i class="fa-solid fa-check"></i>';
                        this.disabled = false;
                    });
            });

            // Address form toggle
            document.getElementById('add-new-address').addEventListener('click', function() {
                document.getElementById('new-address-form').style.display = 'block';
                this.style.display = 'none';
            });

            document.getElementById('cancel-new-address').addEventListener('click', function() {
                document.getElementById('new-address-form').style.display = 'none';
                document.getElementById('add-new-address').style.display = 'block';
            });

            // Payment form toggle
            document.getElementById('add-new-payment').addEventListener('click', function() {
                document.getElementById('new-payment-form').style.display = 'block';
                this.style.display = 'none';
            });

            document.getElementById('cancel-new-payment').addEventListener('click', function() {
                document.getElementById('new-payment-form').style.display = 'none';
                document.getElementById('add-new-payment').style.display = 'block';
            });

            // Save new address
            document.getElementById('save-new-address').addEventListener('click', saveNewAddressHandler);

            // Save new payment method
            document.getElementById('save-new-payment').addEventListener('click', function() {
                const cardName = document.getElementById('card-name').value;
                const savePayment = document.getElementById('save-payment').checked;
                
                if (!cardName) {
                    alert('Please enter the name on the card.');
                    return;
                }

                // Validate card details with Stripe
                validateCardDetails()
                    .then(paymentMethod => {
                        const paymentData = {
                            name: cardName,
                            last4: paymentMethod.card.last4,
                            brand: paymentMethod.card.brand,
                            expiryMonth: paymentMethod.card.exp_month,
                            expiryYear: paymentMethod.card.exp_year,
                            stripePaymentMethodId: paymentMethod.id,
                            default: document.getElementById('payment-methods-list').childElementCount === 0
                        };

                        savePayment ? saveNewPaymentMethod(paymentData) : addPaymentMethodToUI(paymentData, 'temp-' + Date.now());
                        
                        document.getElementById('new-payment-form').style.display = 'none';
                        document.getElementById('add-new-payment').style.display = 'block';
                    })
                    .catch(error => {
                        document.getElementById('card-errors').textContent = error.message;
                    });
            });

            // Apply promo code
            document.getElementById('apply-promo').addEventListener('click', function() {
                const promoCode = document.getElementById('promo').value;
                
                if (!promoCode) {
                    alert('Please enter a promo code.');
                    return;
                }

                // Show loading state
                this.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                this.disabled = true;

                // Validate promo code
                validatePromoCode(promoCode)
                    .then(discount => {
                        if (discount) {
                            // Update totals with discount
                            const subtotalText = document.getElementById('subtotal').textContent;
                            const subtotal = parseFloat(subtotalText.replace('$', ''));
                            const discountAmount = subtotal * (discount / 100);
                            
                            // Add discount to summary
                            const summaryItems = document.querySelector('.summary-items');
                            const discountElement = document.createElement('div');
                            discountElement.className = 'summary-item';
                            discountElement.innerHTML = `
                                <span>Discount (${discount}%)</span>
                                <span>-$${discountAmount.toFixed(2)}</span>
                            `;
                            summaryItems.appendChild(discountElement);
                            
                            // Update total
                            const newTotal = subtotal - discountAmount;
                            document.getElementById('total').textContent = '$' + newTotal.toFixed(2);
                            
                            // Update promo field
                            document.getElementById('promo').disabled = true;
                            document.getElementById('promo').style.backgroundColor = '#f5f5f5';
                            
                            // Update button
                            this.innerHTML = '<i class="fa-solid fa-check"></i> Applied';
                            this.disabled = true;
                        } else {
                            alert('Invalid or expired promo code.');
                            this.innerHTML = 'Apply';
                            this.disabled = false;
                        }
                    })
                    .catch(error => {
                        alert('Error validating promo code: ' + error.message);
                        this.innerHTML = 'Apply';
                        this.disabled = false;
                    });
            });
        });
    </script>
  <script src="assets/header-navigation.js"></script>
  </body>
</html>
